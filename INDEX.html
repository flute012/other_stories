<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>èª²ç¨‹å­¸ç¿’ç³»çµ±</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="app-container">
    <!-- é ‚éƒ¨å€åŸŸ -->
    <div class="top-section">
      <!-- Logo å’Œèª²æ¬¡æ¨™ç±¤ -->
      <div class="header">
        <img src="violet.png" alt="Logo" class="logo">
        <div class="lesson-tabs" id="lessonTabs"></div>
      </div>
      
      <!-- å°èˆªé» -->
      <div class="nav-dots-container" id="navDots"></div>
    </div>

    <!-- å…§å®¹å€åŸŸ -->
    <div class="content-area">
      <!-- å·¦å´å†Šæ¬¡åˆ—è¡¨ -->
      <div class="sidebar" id="bookList"></div>

      <!-- èª²ç¨‹æ»‘å‹•å€åŸŸ -->
      <div class="lesson-slider-container" id="lessonSlider"></div>
    </div>
  </div>

  <script type="module">
    import LessonSlider from './LessonSlider.js';
    import NavDots from './NavDots.js';
    import { booksData, getLessonsForBook } from './data.js';

    // å…¨åŸŸè®Šæ•¸
    let currentBookIndex = 0;
    let currentLessonsData = [];
    let lessonSlider;
    let navDots;
    let lessonTabs;

    // åˆå§‹åŒ–å†Šæ¬¡åˆ—è¡¨
    function initBookList() {
      const bookList = document.getElementById('bookList');
      
      booksData.forEach((book, index) => {
        const bookItem = document.createElement('div');
        bookItem.className = 'book-item';
        if (index === 0) {
          bookItem.classList.add('active');
        }
        
        bookItem.innerHTML = `
          <img src="${book.image}" alt="${book.name}">
          <span>${book.name}</span>
        `;
        
        bookItem.addEventListener('click', () => {
          switchBook(index);
        });
        
        bookList.appendChild(bookItem);
      });
    }

    // åˆ‡æ›å†Šæ¬¡
    function switchBook(bookIndex) {
      console.log(`åˆ‡æ›åˆ°${booksData[bookIndex].name}`);
      
      // æ›´æ–°å´é‚Šæ¬„ active ç‹€æ…‹
      document.querySelectorAll('.book-item').forEach((item, idx) => {
        if (idx === bookIndex) {
          item.classList.add('active');
        } else {
          item.classList.remove('active');
        }
      });
      
      // æ›´æ–°ç•¶å‰å†Šæ¬¡è³‡æ–™
      currentBookIndex = bookIndex;
      currentLessonsData = getLessonsForBook(bookIndex);
      
      // æ›´æ–°æ»‘å‹•å™¨
      lessonSlider.setBook(bookIndex, currentLessonsData);
      
      // é‡ç½®å°èˆªé»
      navDots.setActive(0);
      
      // é‡ç½®èª²æ¬¡æ¨™ç±¤
      lessonTabs.reset(currentLessonsData);
    }

    // åˆå§‹åŒ–èª²æ¬¡æ¨™ç±¤
    function initLessonTabs() {
      const tabsContainer = document.getElementById('lessonTabs');
      const visibleTabs = 5;
      const centerIndex = Math.floor(visibleTabs / 2);
      
      console.log('=== é–‹å§‹ç”Ÿæˆèª²æ¬¡æ¨™ç±¤ ===');
      console.log('å®¹å™¨å…ƒç´ :', tabsContainer);
      console.log('ç•¶å‰èª²ç¨‹è³‡æ–™é•·åº¦:', currentLessonsData.length);
      console.log('è¦é¡¯ç¤ºçš„æ¨™ç±¤æ•¸:', visibleTabs);
      
      if (!currentLessonsData || currentLessonsData.length === 0) {
        console.error('âŒ éŒ¯èª¤ï¼šcurrentLessonsData æ˜¯ç©ºçš„ï¼');
        return;
      }
      
      // æ¸…ç©ºå®¹å™¨
      tabsContainer.innerHTML = '';
      
      // ç”Ÿæˆåˆå§‹æ¨™ç±¤
      for (let i = 0; i < visibleTabs && i < currentLessonsData.length; i++) {
        const tab = document.createElement('div');
        tab.className = 'lesson-tab';
        if (i === centerIndex) {
          tab.classList.add('active');
        }
        tab.textContent = currentLessonsData[i].code;
        tab.dataset.lessonIndex = i;
        tabsContainer.appendChild(tab);
        console.log(`  ç”Ÿæˆæ¨™ç±¤ ${i}:`, currentLessonsData[i].code);
      }
      
      const tabs = tabsContainer.querySelectorAll('.lesson-tab');
      console.log('âœ“ æ¨™ç±¤ç”Ÿæˆå®Œæˆï¼Œç¸½æ•¸:', tabs.length);
      console.log('=== èª²æ¬¡æ¨™ç±¤ç”ŸæˆçµæŸ ===');
      
      return {
        tabs: tabs,
        reset: function(lessonsData) {
          console.log('é‡ç½®èª²æ¬¡æ¨™ç±¤ï¼Œæ–°èª²ç¨‹æ•¸:', lessonsData.length);
          this.tabs.forEach((tab, i) => {
            if (lessonsData[i]) {
              tab.textContent = lessonsData[i].code;
              tab.dataset.lessonIndex = i;
              tab.style.display = 'flex';
              
              if (i === centerIndex) {
                tab.classList.add('active');
              } else {
                tab.classList.remove('active');
              }
            } else {
              tab.style.display = 'none';
            }
          });
        },
        update: function(currentIndex) {
          const lessonsData = currentLessonsData;
          let startIndex = Math.max(0, currentIndex - centerIndex);
          const endIndex = Math.min(lessonsData.length, startIndex + visibleTabs);
          
          if (endIndex === lessonsData.length) {
            startIndex = Math.max(0, lessonsData.length - visibleTabs);
          }
          
          this.tabs.forEach((tab, i) => {
            const lessonIndex = startIndex + i;
            if (lessonIndex < lessonsData.length) {
              tab.textContent = lessonsData[lessonIndex].code;
              tab.dataset.lessonIndex = lessonIndex;
              tab.style.display = 'flex';
              
              if (lessonIndex === currentIndex) {
                tab.classList.add('active');
              } else {
                tab.classList.remove('active');
              }
            } else {
              tab.style.display = 'none';
            }
          });
        },
        bindClickEvents: function() {
          console.log('ç¶å®šèª²æ¬¡æ¨™ç±¤é»æ“Šäº‹ä»¶');
          this.tabs.forEach((tab, idx) => {
            tab.addEventListener('click', () => {
              const lessonIndex = parseInt(tab.dataset.lessonIndex);
              console.log('é»æ“Šèª²æ¬¡æ¨™ç±¤:', tab.textContent, 'ç´¢å¼•:', lessonIndex);
              if (!isNaN(lessonIndex)) {
                lessonSlider.goTo(lessonIndex);
              }
            });
          });
          console.log('âœ“ é»æ“Šäº‹ä»¶ç¶å®šå®Œæˆ');
        }
      };
    }

    // ç­‰å¾… DOM è¼‰å…¥
    document.addEventListener('DOMContentLoaded', () => {
      console.log('é–‹å§‹åˆå§‹åŒ–...');
      
      // 1. å–å¾—ç¬¬ä¸€å†Šçš„èª²ç¨‹è³‡æ–™ï¼ˆæœ€å…ˆåŸ·è¡Œï¼‰
      currentLessonsData = getLessonsForBook(0);
      console.log('âœ“ è¼‰å…¥ç¬¬ä¸€å†Šè³‡æ–™ï¼Œèª²ç¨‹æ•¸:', currentLessonsData.length);
      console.log('ç¬¬ä¸€èª²è³‡æ–™:', currentLessonsData[0]);
      
      // 2. åˆå§‹åŒ–å†Šæ¬¡åˆ—è¡¨
      initBookList();
      console.log('âœ“ å†Šæ¬¡åˆ—è¡¨åˆå§‹åŒ–å®Œæˆ');
      
      // 3. åˆå§‹åŒ–èª²æ¬¡æ¨™ç±¤ï¼ˆç¢ºä¿ currentLessonsData å·²è¼‰å…¥ï¼‰
      lessonTabs = initLessonTabs();
      lessonTabs.bindClickEvents();
      console.log('âœ“ èª²æ¬¡æ¨™ç±¤åˆå§‹åŒ–å®Œæˆï¼Œé¡¯ç¤º:', lessonTabs.tabs.length, 'å€‹æ¨™ç±¤');
      
      // 4. åˆå§‹åŒ–å°èˆªé»
      navDots = new NavDots(document.getElementById('navDots'), {
        onDotClick: (lessonIndex) => {
          lessonSlider.goTo(lessonIndex);
        }
      });
      console.log('âœ“ å°èˆªé»åˆå§‹åŒ–å®Œæˆ');

      // 5. åˆå§‹åŒ–èª²ç¨‹æ»‘å‹•å™¨
      lessonSlider = new LessonSlider(document.getElementById('lessonSlider'), {
        onSlideChange: (lessonIndex, dotIndex) => {
          navDots.setActive(dotIndex);
          lessonTabs.update(lessonIndex);
        }
      });
      lessonSlider.setBook(0, currentLessonsData);
      console.log('âœ“ èª²ç¨‹æ»‘å‹•å™¨åˆå§‹åŒ–å®Œæˆ');
      
      console.log('ğŸ‰ æ‰€æœ‰åˆå§‹åŒ–å®Œæˆï¼');
    });
  </script>
</body>
</html>